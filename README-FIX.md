# å¤šç”¨æˆ·è¿æ¥é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ” é—®é¢˜æè¿°

æ‚¨åæ˜ çš„é—®é¢˜ï¼š**"å½“æˆ‘åœ¨ä¸åŒå®¢æˆ·ç«¯ç™»å½•åï¼Œå…¶ä»–å·²ç™»å½•å®¢æˆ·ç«¯çš„ç”¨æˆ·ä¿¡æ¯è¢«åŒæ­¥äº†"**

## ğŸ“‹ é—®é¢˜æ ¹å› åˆ†æ

é€šè¿‡åˆ†ææ—¥å¿—å’Œä»£ç ï¼Œå‘ç°äº†ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

### 1. **æ ¸å¿ƒå†²çª**
```typescript
// socketService.ts ç¬¬83-90è¡Œï¼šé˜»æ­¢é‡å¤ç™»å½•
const existingOnlineUser = await OnlineUserModel.findByUsername(username);
if (existingOnlineUser) {
  socket.emit('error', { message: 'Username already taken' });
  return;
}

// OnlineUser.ts ç¬¬23è¡Œï¼šä½¿ç”¨è¦†ç›–å¼æ’å…¥
'INSERT OR REPLACE INTO online_users ...'  // âš ï¸ è¿™ä¼šè¦†ç›–ç°æœ‰è®°å½•
```

### 2. **æ•°æ®åº“è®¾è®¡å±€é™**
- `online_users` è¡¨ä»¥ `socket_id` ä¸ºä¸»é”®
- ä¸æ”¯æŒåŒä¸€ç”¨æˆ·çš„å¤šè®¾å¤‡ç™»å½•
- ç¼ºå°‘è®¾å¤‡æ ‡è¯†å­—æ®µ

### 3. **æœåŠ¡å™¨å®ä¾‹å†²çª**
- æ—¥å¿—æ˜¾ç¤ºå¤šä¸ª `EADDRINUSE` é”™è¯¯
- å¤šä¸ªæœåŠ¡å™¨å®ä¾‹åŒæ—¶è¿è¡Œå¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

## ğŸ› ï¸ ç«‹å³ä¿®å¤æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåœæ­¢å¤šä½™çš„æœåŠ¡å™¨å®ä¾‹

```bash
# æŸ¥æ‰¾å ç”¨3001ç«¯å£çš„è¿›ç¨‹
lsof -i :3001

# æ€æ­»æ‰€æœ‰è¿›ç¨‹
lsof -ti:3001 | xargs kill -9

# æˆ–è€…è¿è¡Œæ¸…ç†è„šæœ¬
./scripts/run-tests.sh clean
```

### ç¬¬äºŒæ­¥ï¼šåº”ç”¨æ•°æ®åº“ä¿®å¤

```bash
# å¤‡ä»½ç°æœ‰æ•°æ®åº“
cp data/app.db data/app.db.backup

# åº”ç”¨schemaä¿®å¤ï¼ˆæ·»åŠ device_idå­—æ®µï¼‰
sqlite3 data/app.db < src/database/schema.fixed.sql
```

### ç¬¬ä¸‰æ­¥ï¼šåº”ç”¨ä»£ç ä¿®å¤

```bash
# å¤‡ä»½åŸå§‹æ–‡ä»¶
cp src/services/socketService.ts src/services/socketService.ts.backup
cp src/models/OnlineUser.ts src/models/OnlineUser.ts.backup
cp src/config/index.ts src/config/index.ts.backup

# åº”ç”¨ä¿®å¤
cp src/services/socketService.fixed.ts src/services/socketService.ts
cp src/models/OnlineUser.fixed.ts src/models/OnlineUser.ts
cp src/config/index.fixed.ts src/config/index.ts
```

### ç¬¬å››æ­¥ï¼šæ›´æ–°ç±»å‹å®šä¹‰

åœ¨ `src/types/index.ts` ä¸­æ·»åŠ ï¼š

```typescript
export interface OnlineUser {
  socketId: string;
  userId: string;
  username: string;
  deviceId?: string;  // æ–°å¢
  joinedAt: Date;
  lastPing?: Date;
}
```

### ç¬¬äº”æ­¥ï¼šé‡æ–°å¯åŠ¨æœåŠ¡å™¨

```bash
# æ¸…ç†æ„å»ºæ–‡ä»¶
rm -rf dist/

# é‡æ–°ç¼–è¯‘å’Œå¯åŠ¨
npm run build  # å¦‚æœæœ‰buildè„šæœ¬
npm run dev
```

## ğŸ§ª éªŒè¯ä¿®å¤æ•ˆæœ

### è¿è¡Œè‡ªåŠ¨æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
./scripts/run-tests.sh auto

# æˆ–è€…æ‰‹åŠ¨æµ‹è¯•
node quick-test.js
```

### æ‰‹åŠ¨éªŒè¯åœºæ™¯

1. **å¤šè®¾å¤‡ç™»å½•æµ‹è¯•**ï¼š
   - æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨/è®¾å¤‡
   - ä½¿ç”¨ç›¸åŒç”¨æˆ·åç™»å½•
   - éªŒè¯æ˜¯å¦æŒ‰é¢„æœŸå¤„ç†

2. **æ¶ˆæ¯åŒæ­¥æµ‹è¯•**ï¼š
   - åœ¨ä¸€ä¸ªè®¾å¤‡å‘é€æ¶ˆæ¯
   - éªŒè¯å…¶ä»–è®¾å¤‡æ˜¯å¦æ­£ç¡®æ¥æ”¶

3. **æ–­çº¿é‡è¿æµ‹è¯•**ï¼š
   - æ–­å¼€ä¸€ä¸ªè®¾å¤‡çš„ç½‘ç»œ
   - é‡æ–°è¿æ¥
   - éªŒè¯çŠ¶æ€æ˜¯å¦æ­£ç¡®æ¢å¤

## âš™ï¸ é…ç½®é€‰é¡¹

ä¿®å¤åï¼Œæ‚¨å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶è¡Œä¸ºï¼š

```bash
# å…è®¸å¤šè®¾å¤‡ç™»å½•ï¼ˆæ¨èï¼‰
ALLOW_MULTI_DEVICE_LOGIN=true

# æ¯ä¸ªç”¨æˆ·æœ€å¤§è¿æ¥æ•°
MAX_CONNECTIONS_PER_USER=3

# ç¦ç”¨å¤šè®¾å¤‡ç™»å½•ï¼ˆå¼ºåˆ¶å•è®¾å¤‡ï¼‰
ALLOW_MULTI_DEVICE_LOGIN=false
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ï¼š
- âŒ æ–°å®¢æˆ·ç«¯ç™»å½•å¯¼è‡´è€å®¢æˆ·ç«¯çŠ¶æ€æ··ä¹±
- âŒ ç”¨æˆ·ä¿¡æ¯è¢«æ„å¤–åŒæ­¥/è¦†ç›–
- âŒ å¤šä¸ªæœåŠ¡å™¨å®ä¾‹å†²çª

### ä¿®å¤åï¼š
- âœ… æ”¯æŒå¯é…ç½®çš„å¤šè®¾å¤‡ç™»å½•ç­–ç•¥
- âœ… ç”¨æˆ·çŠ¶æ€ç‹¬ç«‹ç»´æŠ¤
- âœ… å®Œå–„çš„è¿æ¥ç®¡ç†å’Œæ¸…ç†æœºåˆ¶
- âœ… è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šä¿®å¤å‰è¯·åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
2. **æ¸è¿›å¼éƒ¨ç½²**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
3. **é…ç½®è°ƒæ•´**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´å¤šè®¾å¤‡ç™»å½•ç­–ç•¥
4. **ç›‘æ§è§‚å¯Ÿ**ï¼šä¿®å¤åå¯†åˆ‡è§‚å¯Ÿæ—¥å¿—å’Œç”¨æˆ·åé¦ˆ

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä¿®å¤è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ `logs/error.log` è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. è¿è¡Œ `./scripts/run-tests.sh logs` æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
3. ä½¿ç”¨ `node quick-test.js` è¿›è¡Œå¿«é€Ÿé—®é¢˜éªŒè¯

ä¿®å¤å®Œæˆåï¼Œæ‚¨çš„å¤šç”¨æˆ·è¿æ¥é—®é¢˜åº”è¯¥å¾—åˆ°å½»åº•è§£å†³ï¼